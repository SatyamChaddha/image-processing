% vim:ft=tex
% rubber: module xelatex

\subsection{Distortion removal}

% http://dl.acm.org/citation.cfm?id=1924387
% http://scien.stanford.edu/pages/labsite/2007/psych221/projects/07/geometric_distortion/project.htm
% http://www.embedded-vision.com/industry-analysis/technical-articles/2011/05/14/lens-distortion-correction

% "Straight lines ought to be straight" - \cite{straightlines} .\\
% "Applying and removing lens distortion in post production" - \cite{postproduction} .\\

We investigated forms of distortion removal independent of camera calibration. One particularly useful and simple open-source ANSI C library we discovered was provided by the authors of \cite{algebraic-distortion}. Herein we shall refer to this IPOL library and the algorithm it describes as IPOLdistortion. This implementation estimates the lens distortion parameters of a camera (or image) based on the rectification of lines in the images, as described in e.g. \cite{straightlines}, but with some innovations.

Essentially, \cite{algebraic-distortion} is an optimising process which determines the undistorted coefficients by minimising the error between the input image and its most relevant radial distortion model. The algorithm finds the lens distortion parameters by minimizing a 4 total-degree polynomial in several variables. The mathematical theory behind their implementation (for a full explanation of which, see 

?????

) leads the authors to only consider kappa-0, kappa-2 and kappa-4. The IPOLdistortion algorithm functions by setting the first distortion parameter to 1 (to avoid the trivial solution kappa-0 = 0), and then minimising a distortion error measure function in the form of an energy function of the authors' design. This function is a real-valued polynomial in the variable kappa. To minimise the function, IPOLdistortion finds the solutions to the algebraic system of equations generated by its gradient. The implementation also introduces a "zoom factor" minimising the distance between distorted and corrected points, in order to to create corrected points as close as possible to the distorted ones \cite{algebraic-distortion}.

\subsubsection{Implementation notes}

The IPOLdistortion library requires that users manually select points on the straight line for the algorithm to work on. This can be an arduous process for the user, and is susceptible to human error. Furthermore, \cite{algebraic-distortion} state that for the maximum efficacy, as many straight lines as possible should be used. Therefore in our implementation, we combine the distortion correcting functionality of IPOLdistortion with the line extraction functionality of OpenCV. 

We use OpenCV to automatically extract detected corner points from a (distorted) chessboard image. From these corner points, and our knowledge of the chessboard dimensionality (number of squares per side), we can reconstruct segments which "should" be straight lines in the image. The algorithm we use for this is relatively naive, relying on the fact that OpenCV returns corners in a fixed order. The algorithm is likely to fail if this list is out of order for some reason, or if a subset of points is not returned. For the best performance, the algorithm should take multiple vertical and horizontal lines as input. We therefore provide it with all the horizontal lines returned by the OpenCV code, as well as two vertical lines reconstructed from these.

The actual distortion removal functionality provided by IPOLdistortion consists of first modelling the distortion and then correcting the image based on that model. The IPOLdistortion code only accepts .tif images in an uncompressed format, and our implementation of the algorithm imposes several more constraints on the input image. A key constraint is that the image must be of a (distorted or undistorted) chessboard pattern of at least four squares to a side for the OpenCV code to successfully extract straight lines, and extending this functionality to cover a broader class of images would be an obvious contender for further work. If the input image contains large quantities of noise, OpenCV may not recognise its lines; if it contains unexpected forms of distortion (such as wave distortion), IPOLdistortion may not be able to correctly fit a lens distortion model to it. We next investigate these restrictions and the general capabilities of the algorithm.

\subsubsection{Experimental process.}

\paragraph{Experimental parameters.}
To test our program, we created a suite of 22 different chessboard images. Each was based on a default image we constructed, with dimensionality 8 squares to a side. The images included variations on rotation, image position, artificial barrel and pincushion distortion, unexpected forms of distortion, and noise. We ran each image through our program and compared the results to the baseline undistorted chessboard.

\paragraph{Experimental results.}
We present our findings for each artificial chessboard image.
\begin{enumerate}
  \item The undistorted baseline image. The output appeared unchanged, as expected. 
$0.999994200427223$
$-0.0000000000398119706872993$
$4.80105142502336 \times 10^-015$

  \item 
  \item 
\end{enumerate}

Plain chessboard
Colour chessboard
Barrel distortion
Pincushion distortion
Tilted 22.5 degrees
Tilted 45 degrees
Tilted 45 degrees, barrel
Tilted 45 degrees, pincushion
Tilted 22.5 degrees, barrel
Tilted 22.5 degrees, pincushion
Shifted barrel distortion
Shifted pincushion distortion
Gauss 10 barrel
Gauss 10 pincushion
Spread 10 pincushion
Spread 20 pincushion
Spread 10 barrel
Spread 20 barrel
Barrel plus stretched edge
Pincushion plus stretched edge
Pseudo-Pincushion distortion in board corner
Pseudo-Barrel distortion in board corner


Unchanged, as expected.
Unable to detect corners for straight lines.
Corrected perfectly.
Only found 47 corners. Using these for straight lines let it correct the image but lost the corners.
Unchanged, as expected.
Unchanged, as expected.
Corrected perfectly.
Corrected, but chessboard corners became rounded and some noise added.
Corrected perfectly.
Corrected, but chessboard corners became rounded and some noise added.
Not properly corrected, presumably due to assumption that distortion centre = image centre.
Only found 47 corners, and was unable to generate lines from these.
Unable to detect corners for straight lines.
Only found 37 corners in a circular pattern in the middle, and was unable to generate lines from these.
Only found 42 corners; falsely constructed lines resulting in weird 15a pattern. Surprisingly successful when cut down to 36 corners, losing the chessboard corners but still correcting middle. See 15b.
Unable to detect corners for straight lines.
Corrected perfectly.
Only found 28 corners, and was unable to generate lines from these.
Found corners, but supposedly undistorted image was almost unchanged.
Finds 27 to 33 corners in the middle, but unable to construct lines to run distortion on them
Finds corners, almost no change to ‘undistorted’ image.
Finds 47 corners, unable to reconstruct lines.



Note that \cite{algebraic-distortion} states, "we will always take the center of the image as distortion center".

\[
  \kappa
\]
\[
 k_{0}
 k_{1}
 k_{2}
 k_{3}
 k_{4}
\]


We also ran a number of chessboard images from internet searches and created by hand from distorted grids likewise acquired from internet searches. These confirmed our results on the artificial chessboard suite. It also demonstrated that images of chessboards of strange dimensionalities (such as 4x10 or 14x16) can still be corrected, assuming the size of each chessboard square remains the same, and that the algorithm often cannot handle extreme camera angles or unusual types of noise (such as blotches or heavy noise only at the corners of squares).

\paragraph{Comparison with camera calibration results.}

-> Finally, comparison with camera calibration results: we generated lists of lines for each face of three images, 0027, 0027 with barrel distortion, and 0027 with pincushion distortion. We generated straight lines from the image calibration points, which obviously ought to lie on straight lines. For each case, we used all horizontal lines and the two outer vertical lines from each face. We ran distortion removal on these, and compared the kappa-0, kappa-2 and kappa-4 output of the distortion algorithm to the kappa-1 found by calibration.\\

(INSERT CHARTS HERE)





